#!/usr/bin/env ruby

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), "..")

require './build/scanner'
require './build/parser'
require 'core/vm'

def run_tests files
  vm = Dagon::Core::VM.new
  vm.add_load_path Dir.getwd
  program = %{require("spec/assertions")\nrequire("spec/dspec")\n}
  tokens = Dagon::Scanner.tokenize(program, '(dspec)')
  tree = Dagon::Parser.parse(tokens, '(dspec)', false)
  tree.evaluate(vm)
  files.each do |file|
    path = File.dirname(File.join(Dir.getwd, file))
    vm.add_load_path path
    actual_program = program.dup
    actual_program << File.open(file, 'rb').read
    actual_program << "\n"
    tokens = Dagon::Scanner.tokenize(actual_program, file)
    tree = Dagon::Parser.parse(tokens, file, false)
    tree.evaluate(vm)
  end
end

files = if ARGV[0]
          [ARGV[0]]
        else
          Dir.glob('spec/*_spec.dg')
        end

run_tests(files)
