#!/usr/bin/env ruby

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), "..")

require 'build/scanner'
require 'build/parser'
require 'core/vm'

def run_tests files
  vm = Dagon::Core::VM.new
  program = %{require("spec/dspec")\n}
  tokens = Dagon::Scanner.tokenize(program, '(dspec)')
  tree = Dagon::Parser.parse(tokens, '(dspec)', false)
  tree.evaluate(vm)
  files.each do |file|
    path = File.dirname(File.join(Dir.getwd, file))
    vm.add_load_path path
    actual_program = program.dup
    actual_program << File.open(file, 'rb').read
    actual_program << "\n"
    tokens = Dagon::Scanner.tokenize(actual_program, file)
    tree = Dagon::Parser.parse(tokens, file, false)
    tree.evaluate(vm)
  end
end

def dspec_files
  if ARGV.empty?
    Dir.glob('spec/*_spec.dg')
  else
    ARGV
  end
end

run_tests(dspec_files)
