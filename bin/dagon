#!/usr/bin/env ruby

require 'optparse'
require './build/tokenizer'
require './lib/dagon/interpreter'
require './build/ast/generator'
require 'pp'

options = {}

OptionParser.new do |opts|
  opts.on("-t", "--tokens", "Show only tokens") do |v|
    options[:only_tokens] = v
  end

  opts.on("-d", "--debug", "Debug") do |v|
    options[:debug] = v
  end
end.parse!

def read_program
  if ARGV[0]
    $dagon_cwd = File.dirname(ARGV[0])
    File.read(ARGV[0])
  else
    STDIN.read
  end
end

program = read_program.chomp
tokenizer = Dagon::Tokenizer.new
tokens = tokenizer.tokenize program

if options[:debug]
  puts "-" * 40 + " TOKENS " + "-" * 40
  pp tokens
  puts "-" * 40 + "--------" + "-" * 40
end

tree = Dagon::Ast::Generator.new(tokens, options[:debug]).parse
tree.evaluate
