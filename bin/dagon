#!/usr/bin/env ruby

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), "..")

require 'optparse'
require './dagon/interpreter'
require './build/scanner'
require './build/parser'
require 'pp'


options = {}

OptionParser.new do |opts|
  opts.on("-t", "--tokens", "Show only tokens") do |v|
    options[:only_tokens] = v
  end

  opts.on("-d", "--debug", "Debug") do |v|
    options[:debug] = v
  end
end.parse!

program = nil
filename = nil

if ARGV[0]
  $dagon_cwd = File.dirname(ARGV[0])
  program = File.read(ARGV[0])
  filename = ARGV[0]
else
  program = STDIN.read
  filename = '(stdin)'
end

tokenizer = Dagon::Tokenizer.new
tokens = tokenizer.tokenize program, filename

if options[:debug]
  puts "-" * 40 + " TOKENS " + "-" * 40
  pp tokens
  puts "-" * 40 + "--------" + "-" * 40
end

tree = Dagon::Ast::Generator.new(tokens, options[:debug]).parse
tree.evaluate
