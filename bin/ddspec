#!/usr/bin/env dagon

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), "..")

require './build/scanner'
require './build/parser'
require 'core/vm'

def spec_files
  if !ARGV.empty?
    ARGV
  else
    Dir.glob('spec/*_spec.dg')
  end
end

class DSpecRunner
  def initialize spec_files
    @spec_files = spec_files
    @vm = Dagon::Core::VM.new
  end

  def run_tests
    vm.load_dg("spec/dspec")
    run_spec_files
  end

  private
  attr_reader :spec_files, :vm

  def run_spec_files
    spec_files.each do |file|
      path = File.dirname(File.join(Dir.getwd, file))
      vm.add_load_path path
      vm.load_dg(file.gsub(/\.dg$/, ''))
    end
  end
end

runner = DSpecRunner.new(spec_files)
runner.run_tests
